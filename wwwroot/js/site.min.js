var app = angular.module('RWA.Web', ["ui.router", "duScroll", "ui.bootstrap", "ngMessages", "ui.utils.masks"]);

app.config(function ($stateProvider, $urlRouterProvider, $httpProvider, $locationProvider) {

    $stateProvider
        .state('home', {
            url: "/home",
            reloadOnSearch: false,
            templateUrl: "clientapp/components/home/home.html",
            title: 'RWA Consórcio Cardoso | Especialista em Consórcios'
        })    
        .state('como-fazer-consorcio', {
            url: "/como-fazer-consorcio",            
            reloadOnSearch: false,
            templateUrl: "clientapp/components/home/home.html",
            title: 'Como funciona | Especialista em Consórcios'

        })
        .state('tipos-consorcio', {
            url: "/tipos-consorcio",
            reloadOnSearch: false,
            templateUrl: "clientapp/components/home/home.html",
            title: 'Tipos de Consórcios | Especialista em Consórcios' 
        })
        .state('vantagens', {
            url: "/vantagens",
            reloadOnSearch: false,
            templateUrl: "clientapp/components/home/home.html",
            title: 'Vantagens de fazer | Especialista em Consórcios' 
        })
        .state('depoimentos', {
            url: "/depoimentos",
            reloadOnSearch: false,
            templateUrl: "clientapp/components/home/home.html",
            title: 'Depoimentos | Especialista em Consórcios' 
        })
        .state('contato', {
            url: "/contato",
            reloadOnSearch: false,
            templateUrl: "clientapp/components/home/home.html",
            title: 'Fale Conosco | Especialista em Consórcios'
        })

    $urlRouterProvider.otherwise("/home");    

});
app.directive('routeLoadingIndicator', function ($rootScope, $timeout) {
    return {
        restrict: 'E',
        template: "<div ng-show='isRouteLoading' class='loading-indicator'>" +
                    "<div class='loading-indicator-body'>" +
                    "<div class='spinner'>" +
                    "<img src='images/default/loading.svg' data-fallback='images/default/loading.png' class='ld ld-spin x4 img-responsive center-block' />" +                    
                    "</div>" +
                    "</div>" +
                    "</div>",
        replace: true,
        link: function (scope, elem, attrs) {
            scope.isRouteLoading = false;

            $rootScope.$on('$stateChangeStart', function () {                
                scope.isRouteLoading = true;
            });

            $rootScope.$on('$stateChangeSuccess', function () {
                $timeout(function () {
                    scope.isRouteLoading = false;                    
                }, 2200);
            });
        }
    };
});
app.factory('contatoFactory', function ($http, config) {
    
    var _sendMail = function (contact) {
        return $http.post(config.baseUrl + "/home/sendmail", contact);
    };

    return {
        sendMail: _sendMail
    };

});
app.constant('config', {
    // baseUrl: 'http://localhost:5000' //Local
    // baseUrl: 'http://aspnetcore.fennecfoxsolutions.com.br' //TST    
    baseUrl: 'http://rwaconsorcio.com.br' //Produção
});
app.controller('templateController', ['$scope', function ($scope) {
        
    $scope.scrollPos = 0;
    
    $scope.fecharMenu = function () {
        $scope.isCollapsed = true;
    }
        
    angular.element(document).ready(function () {
        $scope.fecharMenu();
    });

}]);
app.controller('homeController', ['$scope', 'contatoFactory', '$document', '$uibModal', '$location', '$timeout', '$log', function ($scope, contatoFactory, $document, $uibModal, $location, $timeout, $log) {

    $scope.init = function () {
                
        var swiperBanner = new Swiper('#banner-principal', {            
            direction: 'horizontal',
            loop: false,
            autoplay: 8000,
            effect: 'fade',
            speed: 1200,
            autoplayDisableOnInteraction: false,              
            pagination: '.swiper-pagination-banner',
            paginationClickable: true     
        });

        var swiperDepoimentos = new Swiper('#slide-depoimentos', {            
            direction: 'horizontal',
            loop: false,
            autoplay: 8000,
            effect: 'slide',
            speed: 1200,
            autoplayDisableOnInteraction: true,
            pagination: '.swiper-pagination-depoimentos',
            paginationClickable: true      
        });
        
    };

    //Mover para um local

    $scope.moveTo = function (id, offset) {
        var duration = 1500;
        $document.scrollToElement(angular.element(document.getElementById(id)), offset, duration);
    }

    //URL Location

    if ($location.url()) {
        $scope.scrollElement = angular.element(document.getElementById($location.url().replace('/', '').split('?')[0]));
        $scope.offsetElementScroll = parseInt(angular.element(document.querySelector('#' + $location.url().replace('/', '').split('?')[0])).attr('offset'));
        if ($scope.scrollElement) {
            $timeout(function () {
                $document.scrollToElementAnimated($scope.scrollElement, $scope.offsetElementScroll, 1200);
            }, 1000);
        }
    }

    //modal capital de giro

    var modalInstanceCapitalGiro;
    
    $scope.openModalCapitalGiro = function () {
        modalInstanceCapitalGiro = $uibModal.open({
            animation: false,
            templateUrl: './clientapp/components/modal/servico/capital-giro.tmpl.html',
            size: 'lg',
            controller: 'capitalGiroController'
        });
        modalInstanceCapitalGiro.result.then(function (selectedItem) {
            $scope.selected = selectedItem;
        }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });
    };

    //modal depoimento

    var modalInstanceDepoimento;
    
    $scope.openModalDepoimento = function (depoimentoId) {
        modalInstanceDepoimento = $uibModal.open({
            animation: false,
            templateUrl: './clientapp/components/modal/depoimento/depoimento.tmpl.html',
            size: 'lg',
            resolve: {               
                id: function () {
                    return depoimentoId;
                }
            },
            controller: 'depoimentoController'
        });
        modalInstanceDepoimento.result.then(function (selectedItem) {
            $scope.selected = selectedItem;
        }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });
    };


    /* Enviar e-mail */

    $scope.contato = {};
    $scope.emailEnviado = 0; // 0 - não enviado // 01 - Enviado com sucesso // 02 - Erro ao enviar
    $scope.textoBotaoEnviar = 'Enviar';
    $scope.travarBotao = false;

    $scope.contatoReset = angular.copy($scope.contato);

    $scope.enviarEmail = function (contato) {

        $scope.textoBotaoEnviar = 'Enviando...';
        $scope.travarBotao = true;

        contatoFactory.sendMail(contato).then(function (data) {
            console.log(data);
            $scope.contato = angular.copy($scope.contatoReset);
            $scope.formularioContato.$setPristine();
            $scope.formularioContato.$setUntouched();
            $scope.travarBotao = false;
            $scope.textoBotaoEnviar = 'Enviar';
            $scope.emailEnviado = 1;
        }).catch(function (data) {
            console.log(data);
            $scope.textoBotaoEnviar = 'Enviar';
            $scope.travarBotao = false;
            $scope.emailEnviado = 2;
        });
    }

    angular.element(document).ready(function () {
        $scope.init();
    });

}]);
app.controller('capitalGiroController', ['$scope', '$uibModalInstance', function ($scope, $uibModalInstance) {
    
    $scope.cancel = function () {       
        $uibModalInstance.close(false);    
    };

}]);
app.controller('depoimentoController', ['$scope', 'id', '$uibModalInstance', function ($scope, id, $uibModalInstance) {
    
    $scope.activeId = id;

    $scope.cancel = function () {               
        $uibModalInstance.close(false);
    };

}]);